#!/usr/bin/env perl

BEGIN { use lib 't'; require 'testlib.pl'; }

use Modern::Perl;

# alloc_array16 - error no arguments
spew("$test.in", "alloc_array16");
capture_nok("bfpp $test.in", <<END);
$test.in:1:14: error: expected '(' after macro name 'alloc_array16'
END

# alloc_array16 - error empty arguments
spew("$test.in", "alloc_array16()");
capture_nok("bfpp $test.in", <<END);
$test.in:1:16: error: macro 'alloc_array16' expects one identifier and an expression
END

# alloc_array16 - error too many arguments
spew("$test.in", "alloc_array16(A,B,C)");
capture_nok("bfpp $test.in", <<END);
$test.in:1:18: error: expected ')' at end of macro call, found ','
END

# alloc_array16 - wrong type of arguments
spew("$test.in", "alloc_array16(1)");
capture_nok("bfpp $test.in", <<END);
$test.in:1:16: error: expected ',' in macro argument list
END

# alloc_array16 - use as reserved word
spew("$test.in", "#define alloc_array16 1");
capture_nok("bfpp $test.in", <<END);
$test.in:1:9: error: cannot define macro 'alloc_array16': reserved word
END


# free_array16 - error no arguments
spew("$test.in", "free_array16");
capture_nok("bfpp $test.in", <<END);
$test.in:1:13: error: expected '(' after macro name 'free_array16'
END

# free_array16 - error empty arguments
spew("$test.in", "free_array16()");
capture_nok("bfpp $test.in", <<END);
$test.in:1:15: error: macro 'free_array16' expects one identifier
END

# free_array16 - error too many arguments
spew("$test.in", "free_array16(A,B)");
capture_nok("bfpp $test.in", <<END);
$test.in:1:15: error: expected ')' at end of macro call, found ','
END

# free_array16 - wrong type of arguments
spew("$test.in", "free_array16(1)");
capture_nok("bfpp $test.in", <<END);
$test.in:1:16: error: macro 'free_array16' expects one identifier
END

# free_array16 - wrong type of arguments
spew("$test.in", "alloc_cell8(A) free_array16(A)");
capture_nok("bfpp $test.in", <<END);
$test.in:1:31: error: array16: 'A' is not an alloc_array16 result
END

# free_array16 - use as reserved word
spew("$test.in", "#define free_array16 1");
capture_nok("bfpp $test.in", <<END);
$test.in:1:9: error: cannot define macro 'free_array16': reserved word
END


# put_array8 - error no arguments
spew("$test.in", "put_array8");
capture_nok("bfpp $test.in", <<END);
$test.in:1:11: error: expected '(' after macro name 'put_array8'
END

# put_array8 - error empty arguments
spew("$test.in", "put_array8()");
capture_nok("bfpp $test.in", <<END);
$test.in:1:1: error: macro 'put_array8' expects one identifier and 2 expressions
END

# put_array8 - error too many arguments
spew("$test.in", "put_array8(A,B,C,D)");
capture_nok("bfpp $test.in", <<END);
$test.in:1:17: error: expected ')' at end of macro call, found ','
END

# put_array8 - wrong type of arguments
spew("$test.in", "put_array8(1, 0, 0)");
capture_nok("bfpp $test.in", <<END);
$test.in:1:1: error: macro 'put_array8' expects one identifier and 2 expressions
END

# put_array8 - wrong type of arguments
spew("$test.in", "alloc_cell8(A) put_array8(A, 0, 0)");
capture_nok("bfpp $test.in", <<END);
$test.in:1:16: error: array16: 'A' is not an alloc_array16 result
END

# put_array8 - use as reserved word
spew("$test.in", "#define put_array8 1");
capture_nok("bfpp $test.in", <<END);
$test.in:1:9: error: cannot define macro 'put_array8': reserved word
END


# put_array16 - error no arguments
spew("$test.in", "put_array16");
capture_nok("bfpp $test.in", <<END);
$test.in:1:12: error: expected '(' after macro name 'put_array16'
END

# put_array16 - error empty arguments
spew("$test.in", "put_array16()");
capture_nok("bfpp $test.in", <<END);
$test.in:1:1: error: macro 'put_array16' expects one identifier and 2 expressions
END

# put_array16 - error too many arguments
spew("$test.in", "put_array16(A,B,C,D)");
capture_nok("bfpp $test.in", <<END);
$test.in:1:18: error: expected ')' at end of macro call, found ','
END

# put_array16 - wrong type of arguments
spew("$test.in", "put_array16(1, 0, 0)");
capture_nok("bfpp $test.in", <<END);
$test.in:1:1: error: macro 'put_array16' expects one identifier and 2 expressions
END

# put_array16 - wrong type of arguments
spew("$test.in", "alloc_cell8(A) put_array16(A, 0, 0)");
capture_nok("bfpp $test.in", <<END);
$test.in:1:16: error: array16: 'A' is not an alloc_array16 result
END

# put_array16 - use as reserved word
spew("$test.in", "#define put_array16 1");
capture_nok("bfpp $test.in", <<END);
$test.in:1:9: error: cannot define macro 'put_array16': reserved word
END


# get_array8 - error no arguments
spew("$test.in", "get_array8");
capture_nok("bfpp $test.in", <<END);
$test.in:1:11: error: expected '(' after macro name 'get_array8'
END

# get_array8 - error empty arguments
spew("$test.in", "get_array8()");
capture_nok("bfpp $test.in", <<END);
$test.in:1:1: error: macro 'get_array8' expects one identifier and 2 expressions
END

# get_array8 - error too many arguments
spew("$test.in", "get_array8(A,B,C,D)");
capture_nok("bfpp $test.in", <<END);
$test.in:1:17: error: expected ')' at end of macro call, found ','
END

# get_array8 - wrong type of arguments
spew("$test.in", "get_array8(1, 0, 0)");
capture_nok("bfpp $test.in", <<END);
$test.in:1:1: error: macro 'get_array8' expects one identifier and 2 expressions
END

# get_array8 - wrong type of arguments
spew("$test.in", "alloc_cell8(A) get_array8(A, 0, 0)");
capture_nok("bfpp $test.in", <<END);
$test.in:1:16: error: array16: 'A' is not an alloc_array16 result
END

# get_array8 - use as reserved word
spew("$test.in", "#define get_array8 1");
capture_nok("bfpp $test.in", <<END);
$test.in:1:9: error: cannot define macro 'get_array8': reserved word
END


# get_array16 - error no arguments
spew("$test.in", "get_array16");
capture_nok("bfpp $test.in", <<END);
$test.in:1:12: error: expected '(' after macro name 'get_array16'
END

# get_array16 - error empty arguments
spew("$test.in", "get_array16()");
capture_nok("bfpp $test.in", <<END);
$test.in:1:1: error: macro 'get_array16' expects one identifier and 2 expressions
END

# get_array16 - error too many arguments
spew("$test.in", "get_array16(A,B,C,D)");
capture_nok("bfpp $test.in", <<END);
$test.in:1:18: error: expected ')' at end of macro call, found ','
END

# get_array16 - wrong type of arguments
spew("$test.in", "get_array16(1, 0, 0)");
capture_nok("bfpp $test.in", <<END);
$test.in:1:1: error: macro 'get_array16' expects one identifier and 2 expressions
END

# get_array16 - wrong type of arguments
spew("$test.in", "alloc_cell8(A) get_array16(A, 0, 0)");
capture_nok("bfpp $test.in", <<END);
$test.in:1:16: error: array16: 'A' is not an alloc_array16 result
END

# get_array16 - use as reserved word
spew("$test.in", "#define get_array16 1");
capture_nok("bfpp $test.in", <<END);
$test.in:1:9: error: cannot define macro 'get_array16': reserved word
END


# alloc_array16, put data
spew("$test.in", <<END);
alloc_array16(A, 2)
alloc_cell8(IDX)
alloc_cell16(T)

set16(T, 1)     set8(IDX, 0) put_array8(A, IDX, T)
set16(T, 65535) set8(IDX, 1) put_array16(A, IDX, T)
set16(T, 12345) set8(IDX, 2) put_array16(A, IDX, T) // no-op

END
capture_ok("bfpp $test.in", <<END);
[ Generated by bfpp, see https://github.com/pauloscustodio/bf
  3611 instructions, 15 tape cells
]
>>>>[-]>[-]>[-]<[-]+>[-]<<[-]>>>[-]>[-]>[-]<<[-]<<<[->>>+>>+<<<<<]>>>>>[-<<<<<+>
>>>>][-]>[-]<[-]<[->+>+<<]>>[-<<+>>][-]<[-<<->>][-]>[-]<[-]<<[->>+<<]+>>>+<[->[-
<<<->>>]<][-]>[-]<[-]>[-]>[-]<[-]<<<[->>>+>+<<<<]>>>>[-<<<<+>>>>][-]>[-]<[-]<[->
+<]+>>+<[->[-<<->>]<][-]>[-]<[-]<<[-]>[-<+>>+<]>[-<+>][-]>[-]<[-]<<[->>+<<]+>>>+
<[->[-<<<->>>]<][-]>[-]<<<[>>[-]<<<<<<<<<<<[-]>>>>>[-<<<<<+>>>>>>>>>>>+<<<<<<]>>
>>>>[-<<<<<<+>>>>>>][-]<<-]>[<<[-]+>>>[-]<<<<[-]<<<[->>>+>>>>+<<<<<<<]>>>>>>>[-<
<<<<<<+>>>>>>>][-]>[-]<[-]<<<[->>>+>+<<<<]>>>>[-<<<<+>>>>][-]<[-<<<<->>>>][-]>[-
]<[-]<<<<[->>>>+<<<<]+>>>>>+<[->[-<<<<<->>>>>]<][-]>[-]<[-]>[-]>[-]<[-]<<<<<[->>
>>>+>+<<<<<<]>>>>>>[-<<<<<<+>>>>>>][-]>[-]<[-]<[->+<]+>>+<[->[-<<->>]<][-]>[-]<[
-]<<[-]>[-<+>>+<]>[-<+>][-]>[-]<[-]<<[->>+<<]+>>>+<[->[-<<<->>>]<][-]>[-]<<<[>>[
-]<<<<<<<<<<<[-]>>>[-<<<+>>>>>>>>>>>+<<<<<<<<]>>>>>>>>[-<<<<<<<<+>>>>>>>>][-]<<-
]>[-]<[-]>[-]<<-]<[-]>[-]<<<[-]>[-]<<<[-]+++++++++++++++++++++++++++++++++++++++
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
++++++++++++++++++++++++++++++++++++++++++++++++++++++++>[-]++++++++++++++++++++
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++<<[-]
+>>>[-]>[-]>[-]<<[-]<<<[->>>+>>+<<<<<]>>>>>[-<<<<<+>>>>>][-]>[-]<[-]<[->+>+<<]>>
[-<<+>>][-]<[-<<->>][-]>[-]<[-]<<[->>+<<]+>>>+<[->[-<<<->>>]<][-]>[-]<[-]>[-]>[-
]<[-]<<<[->>>+>+<<<<]>>>>[-<<<<+>>>>][-]>[-]<[-]<[->+<]+>>+<[->[-<<->>]<][-]>[-]
<[-]<<[-]>[-<+>>+<]>[-<+>][-]>[-]<[-]<<[->>+<<]+>>>+<[->[-<<<->>>]<][-]>[-]<<<[>
>[-]<<<<<<<<<<<[-]>>>>>[-<<<<<+>>>>>>>>>>>+<<<<<<]>>>>>>[-<<<<<<+>>>>>>][-]<<<<<
<<<<<[-]>>>>>[-<<<<<+>>>>>>>>>>+<<<<<]>>>>>[-<<<<<+>>>>>][-]<<-]>[<<[-]+>>>[-]<<
<<[-]<<<[->>>+>>>>+<<<<<<<]>>>>>>>[-<<<<<<<+>>>>>>>][-]>[-]<[-]<<<[->>>+>+<<<<]>
>>>[-<<<<+>>>>][-]<[-<<<<->>>>][-]>[-]<[-]<<<<[->>>>+<<<<]+>>>>>+<[->[-<<<<<->>>
>>]<][-]>[-]<[-]>[-]>[-]<[-]<<<<<[->>>>>+>+<<<<<<]>>>>>>[-<<<<<<+>>>>>>][-]>[-]<
[-]<[->+<]+>>+<[->[-<<->>]<][-]>[-]<[-]<<[-]>[-<+>>+<]>[-<+>][-]>[-]<[-]<<[->>+<
<]+>>>+<[->[-<<<->>>]<][-]>[-]<<<[>>[-]<<<<<<<<<<<[-]>>>[-<<<+>>>>>>>>>>>+<<<<<<
<<]>>>>>>>>[-<<<<<<<<+>>>>>>>>][-]<<<<<<<<<<[-]>>>[-<<<+>>>>>>>>>>+<<<<<<<]>>>>>
>>[-<<<<<<<+>>>>>>>][-]<<-]>[-]<[-]>[-]<<-]<[-]>[-]<<<[-]>[-]<<<[-]+++++++++++++
++++++++++++++++++++++++++++++++++++++++++++>[-]++++++++++++++++++++++++++++++++
++++++++++++++++<<[-]++>>>[-]>[-]>[-]<<[-]<<<[->>>+>>+<<<<<]>>>>>[-<<<<<+>>>>>][
-]>[-]<[-]<[->+>+<<]>>[-<<+>>][-]<[-<<->>][-]>[-]<[-]<<[->>+<<]+>>>+<[->[-<<<->>
>]<][-]>[-]<[-]>[-]>[-]<[-]<<<[->>>+>+<<<<]>>>>[-<<<<+>>>>][-]>[-]<[-]<[->+<]+>>
+<[->[-<<->>]<][-]>[-]<[-]<<[-]>[-<+>>+<]>[-<+>][-]>[-]<[-]<<[->>+<<]+>>>+<[->[-
<<<->>>]<][-]>[-]<<<[>>[-]<<<<<<<<<<<[-]>>>>>[-<<<<<+>>>>>>>>>>>+<<<<<<]>>>>>>[-
<<<<<<+>>>>>>][-]<<<<<<<<<<[-]>>>>>[-<<<<<+>>>>>>>>>>+<<<<<]>>>>>[-<<<<<+>>>>>][
-]<<-]>[<<[-]+>>>[-]<<<<[-]<<<[->>>+>>>>+<<<<<<<]>>>>>>>[-<<<<<<<+>>>>>>>][-]>[-
]<[-]<<<[->>>+>+<<<<]>>>>[-<<<<+>>>>][-]<[-<<<<->>>>][-]>[-]<[-]<<<<[->>>>+<<<<]
+>>>>>+<[->[-<<<<<->>>>>]<][-]>[-]<[-]>[-]>[-]<[-]<<<<<[->>>>>+>+<<<<<<]>>>>>>[-
<<<<<<+>>>>>>][-]>[-]<[-]<[->+<]+>>+<[->[-<<->>]<][-]>[-]<[-]<<[-]>[-<+>>+<]>[-<
+>][-]>[-]<[-]<<[->>+<<]+>>>+<[->[-<<<->>>]<][-]>[-]<<<[>>[-]<<<<<<<<<<<[-]>>>[-
<<<+>>>>>>>>>>>+<<<<<<<<]>>>>>>>>[-<<<<<<<<+>>>>>>>>][-]<<<<<<<<<<[-]>>>[-<<<+>>
>>>>>>>>+<<<<<<<]>>>>>>>[-<<<<<<<+>>>>>>>][-]<<-]>[-]<[-]>[-]<<-]<[-]>[-]<<<[-]>
[-]<<<<<<<<
END
capture_ok("bfpp $test.in | bf -D", <<END);
Tape:  1   0 255 255   2  57  48 
     ^^^ (ptr=0)

END


# alloc_array16, get data
spew("$test.in", <<END);
alloc_cell8(A)
alloc_cell8(B)
alloc_array16(ARR, 2)
alloc_cell8(IDX)
alloc_cell8(T)

set16(T, 12)  set8(IDX, 0) put_array8(ARR, IDX, T)
set16(T, 34)  set8(IDX, 1) put_array8(ARR, IDX, T)
set16(T, 255) set8(IDX, 2) put_array8(ARR, IDX, T) // no-op

set8(IDX, 0) get_array8(ARR, IDX, A)
set8(IDX, 1) get_array8(ARR, IDX, B)
set8(IDX, 2) get_array8(ARR, IDX, T) // no-op
END
capture_ok("bfpp $test.in", <<END);
[ Generated by bfpp, see https://github.com/pauloscustodio/bf
  5644 instructions, 16 tape cells
]
[-]>[-]>>>>>[-]>[-]++++++++++++>[-]<<[-]>>[-]>[-]>[-]<<[-]<<[->>+>>+<<<<]>>>>[-<
<<<+>>>>][-]>[-]<[-]<[->+>+<<]>>[-<<+>>][-]<[-<<->>][-]>[-]<[-]<<[->>+<<]+>>>+<[
->[-<<<->>>]<][-]>[-]<[-]>[-]>[-]<[-]<<<[->>>+>+<<<<]>>>>[-<<<<+>>>>][-]>[-]<[-]
<[->+<]+>>+<[->[-<<->>]<][-]>[-]<[-]<<[-]>[-<+>>+<]>[-<+>][-]>[-]<[-]<<[->>+<<]+
>>>+<[->[-<<<->>>]<][-]>[-]<<<[>>[-]<<<<<<<<<<[-]>>>>>[-<<<<<+>>>>>>>>>>+<<<<<]>
>>>>[-<<<<<+>>>>>][-]<<-]>[<<[-]+>>>[-]<<<<[-]<<[->>+>>>>+<<<<<<]>>>>>>[-<<<<<<+
>>>>>>][-]>[-]<[-]<<<[->>>+>+<<<<]>>>>[-<<<<+>>>>][-]<[-<<<<->>>>][-]>[-]<[-]<<<
<[->>>>+<<<<]+>>>>>+<[->[-<<<<<->>>>>]<][-]>[-]<[-]>[-]>[-]<[-]<<<<<[->>>>>+>+<<
<<<<]>>>>>>[-<<<<<<+>>>>>>][-]>[-]<[-]<[->+<]+>>+<[->[-<<->>]<][-]>[-]<[-]<<[-]>
[-<+>>+<]>[-<+>][-]>[-]<[-]<<[->>+<<]+>>>+<[->[-<<<->>>]<][-]>[-]<<<[>>[-]<<<<<<
<<<<[-]>>>[-<<<+>>>>>>>>>>+<<<<<<<]>>>>>>>[-<<<<<<<+>>>>>>>][-]<<-]>[-]<[-]>[-]<
<-]<[-]>[-]<<<[-]>[-]<<[-]++++++++++++++++++++++++++++++++++>[-]<<[-]+>>[-]>[-]>
[-]<<[-]<<[->>+>>+<<<<]>>>>[-<<<<+>>>>][-]>[-]<[-]<[->+>+<<]>>[-<<+>>][-]<[-<<->
>][-]>[-]<[-]<<[->>+<<]+>>>+<[->[-<<<->>>]<][-]>[-]<[-]>[-]>[-]<[-]<<<[->>>+>+<<
<<]>>>>[-<<<<+>>>>][-]>[-]<[-]<[->+<]+>>+<[->[-<<->>]<][-]>[-]<[-]<<[-]>[-<+>>+<
]>[-<+>][-]>[-]<[-]<<[->>+<<]+>>>+<[->[-<<<->>>]<][-]>[-]<<<[>>[-]<<<<<<<<<<[-]>
>>>>[-<<<<<+>>>>>>>>>>+<<<<<]>>>>>[-<<<<<+>>>>>][-]<<-]>[<<[-]+>>>[-]<<<<[-]<<[-
>>+>>>>+<<<<<<]>>>>>>[-<<<<<<+>>>>>>][-]>[-]<[-]<<<[->>>+>+<<<<]>>>>[-<<<<+>>>>]
[-]<[-<<<<->>>>][-]>[-]<[-]<<<<[->>>>+<<<<]+>>>>>+<[->[-<<<<<->>>>>]<][-]>[-]<[-
]>[-]>[-]<[-]<<<<<[->>>>>+>+<<<<<<]>>>>>>[-<<<<<<+>>>>>>][-]>[-]<[-]<[->+<]+>>+<
[->[-<<->>]<][-]>[-]<[-]<<[-]>[-<+>>+<]>[-<+>][-]>[-]<[-]<<[->>+<<]+>>>+<[->[-<<
<->>>]<][-]>[-]<<<[>>[-]<<<<<<<<<<[-]>>>[-<<<+>>>>>>>>>>+<<<<<<<]>>>>>>>[-<<<<<<
<+>>>>>>>][-]<<-]>[-]<[-]>[-]<<-]<[-]>[-]<<<[-]>[-]<<[-]++++++++++++++++++++++++
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++>[-]<<[-]
++>>[-]>[-]>[-]<<[-]<<[->>+>>+<<<<]>>>>[-<<<<+>>>>][-]>[-]<[-]<[->+>+<<]>>[-<<+>
>][-]<[-<<->>][-]>[-]<[-]<<[->>+<<]+>>>+<[->[-<<<->>>]<][-]>[-]<[-]>[-]>[-]<[-]<
<<[->>>+>+<<<<]>>>>[-<<<<+>>>>][-]>[-]<[-]<[->+<]+>>+<[->[-<<->>]<][-]>[-]<[-]<<
[-]>[-<+>>+<]>[-<+>][-]>[-]<[-]<<[->>+<<]+>>>+<[->[-<<<->>>]<][-]>[-]<<<[>>[-]<<
<<<<<<<<[-]>>>>>[-<<<<<+>>>>>>>>>>+<<<<<]>>>>>[-<<<<<+>>>>>][-]<<-]>[<<[-]+>>>[-
]<<<<[-]<<[->>+>>>>+<<<<<<]>>>>>>[-<<<<<<+>>>>>>][-]>[-]<[-]<<<[->>>+>+<<<<]>>>>
[-<<<<+>>>>][-]<[-<<<<->>>>][-]>[-]<[-]<<<<[->>>>+<<<<]+>>>>>+<[->[-<<<<<->>>>>]
<][-]>[-]<[-]>[-]>[-]<[-]<<<<<[->>>>>+>+<<<<<<]>>>>>>[-<<<<<<+>>>>>>][-]>[-]<[-]
<[->+<]+>>+<[->[-<<->>]<][-]>[-]<[-]<<[-]>[-<+>>+<]>[-<+>][-]>[-]<[-]<<[->>+<<]+
>>>+<[->[-<<<->>>]<][-]>[-]<<<[>>[-]<<<<<<<<<<[-]>>>[-<<<+>>>>>>>>>>+<<<<<<<]>>>
>>>>[-<<<<<<<+>>>>>>>][-]<<-]>[-]<[-]>[-]<<-]<[-]>[-]<<<[-]>[-]<<<[-]>>[-]>[-]>[
-]<<[-]<<[->>+>>+<<<<]>>>>[-<<<<+>>>>][-]>[-]<[-]<[->+>+<<]>>[-<<+>>][-]<[-<<->>
][-]>[-]<[-]<<[->>+<<]+>>>+<[->[-<<<->>>]<][-]>[-]<[-]>[-]>[-]<[-]<<<[->>>+>+<<<
<]>>>>[-<<<<+>>>>][-]>[-]<[-]<[->+<]+>>+<[->[-<<->>]<][-]>[-]<[-]<<[-]>[-<+>>+<]
>[-<+>][-]>[-]<[-]<<[->>+<<]+>>>+<[->[-<<<->>>]<][-]>[-]<<<[>>[-]<<<<<<<<<<<<[-]
>>[-<<+>>>>>>>>>>>>+<<<<<<<<<<]>>>>>>>>>>[-<<<<<<<<<<+>>>>>>>>>>][-]<<-]>[<<[-]+
>>>[-]<<<<[-]<<[->>+>>>>+<<<<<<]>>>>>>[-<<<<<<+>>>>>>][-]>[-]<[-]<<<[->>>+>+<<<<
]>>>>[-<<<<+>>>>][-]<[-<<<<->>>>][-]>[-]<[-]<<<<[->>>>+<<<<]+>>>>>+<[->[-<<<<<->
>>>>]<][-]>[-]<[-]>[-]>[-]<[-]<<<<<[->>>>>+>+<<<<<<]>>>>>>[-<<<<<<+>>>>>>][-]>[-
]<[-]<[->+<]+>>+<[->[-<<->>]<][-]>[-]<[-]<<[-]>[-<+>>+<]>[-<+>][-]>[-]<[-]<<[->>
+<<]+>>>+<[->[-<<<->>>]<][-]>[-]<<<[>>[-]<<<<<<<<<<<<<<[-]>>>>[-<<<<+>>>>>>>>>>>
>>>+<<<<<<<<<<]>>>>>>>>>>[-<<<<<<<<<<+>>>>>>>>>>][-]<<-]>[-]<[-]>[-]<<-]<[-]>[-]
<<<[-]>[-]<<<[-]+>>[-]>[-]>[-]<<[-]<<[->>+>>+<<<<]>>>>[-<<<<+>>>>][-]>[-]<[-]<[-
>+>+<<]>>[-<<+>>][-]<[-<<->>][-]>[-]<[-]<<[->>+<<]+>>>+<[->[-<<<->>>]<][-]>[-]<[
-]>[-]>[-]<[-]<<<[->>>+>+<<<<]>>>>[-<<<<+>>>>][-]>[-]<[-]<[->+<]+>>+<[->[-<<->>]
<][-]>[-]<[-]<<[-]>[-<+>>+<]>[-<+>][-]>[-]<[-]<<[->>+<<]+>>>+<[->[-<<<->>>]<][-]
>[-]<<<[>>[-]<<<<<<<<<<<[-]>[-<+>>>>>>>>>>>+<<<<<<<<<<]>>>>>>>>>>[-<<<<<<<<<<+>>
>>>>>>>>][-]<<-]>[<<[-]+>>>[-]<<<<[-]<<[->>+>>>>+<<<<<<]>>>>>>[-<<<<<<+>>>>>>][-
]>[-]<[-]<<<[->>>+>+<<<<]>>>>[-<<<<+>>>>][-]<[-<<<<->>>>][-]>[-]<[-]<<<<[->>>>+<
<<<]+>>>>>+<[->[-<<<<<->>>>>]<][-]>[-]<[-]>[-]>[-]<[-]<<<<<[->>>>>+>+<<<<<<]>>>>
>>[-<<<<<<+>>>>>>][-]>[-]<[-]<[->+<]+>>+<[->[-<<->>]<][-]>[-]<[-]<<[-]>[-<+>>+<]
>[-<+>][-]>[-]<[-]<<[->>+<<]+>>>+<[->[-<<<->>>]<][-]>[-]<<<[>>[-]<<<<<<<<<<<<<[-
]>>>[-<<<+>>>>>>>>>>>>>+<<<<<<<<<<]>>>>>>>>>>[-<<<<<<<<<<+>>>>>>>>>>][-]<<-]>[-]
<[-]>[-]<<-]<[-]>[-]<<<[-]>[-]<<<[-]++>>[-]>[-]>[-]<<[-]<<[->>+>>+<<<<]>>>>[-<<<
<+>>>>][-]>[-]<[-]<[->+>+<<]>>[-<<+>>][-]<[-<<->>][-]>[-]<[-]<<[->>+<<]+>>>+<[->
[-<<<->>>]<][-]>[-]<[-]>[-]>[-]<[-]<<<[->>>+>+<<<<]>>>>[-<<<<+>>>>][-]>[-]<[-]<[
->+<]+>>+<[->[-<<->>]<][-]>[-]<[-]<<[-]>[-<+>>+<]>[-<+>][-]>[-]<[-]<<[->>+<<]+>>
>+<[->[-<<<->>>]<][-]>[-]<<<[>>[-]<<<<<[-]<<<<<[->>>>>+>>>>>+<<<<<<<<<<]>>>>>>>>
>>[-<<<<<<<<<<+>>>>>>>>>>][-]<<-]>[<<[-]+>>>[-]<<<<[-]<<[->>+>>>>+<<<<<<]>>>>>>[
-<<<<<<+>>>>>>][-]>[-]<[-]<<<[->>>+>+<<<<]>>>>[-<<<<+>>>>][-]<[-<<<<->>>>][-]>[-
]<[-]<<<<[->>>>+<<<<]+>>>>>+<[->[-<<<<<->>>>>]<][-]>[-]<[-]>[-]>[-]<[-]<<<<<[->>
>>>+>+<<<<<<]>>>>>>[-<<<<<<+>>>>>>][-]>[-]<[-]<[->+<]+>>+<[->[-<<->>]<][-]>[-]<[
-]<<[-]>[-<+>>+<]>[-<+>][-]>[-]<[-]<<[->>+<<]+>>>+<[->[-<<<->>>]<][-]>[-]<<<[>>[
-]<<<<<<<[-]<<<[->>>+>>>>>>>+<<<<<<<<<<]>>>>>>>>>>[-<<<<<<<<<<+>>>>>>>>>>][-]<<-
]>[-]<[-]>[-]<<-]<[-]>[-]<<<[-]>[-]<<<<<<<<<
END
capture_ok("bfpp $test.in | bf -D", <<END);
Tape: 12  34  12   0  34   0   2 255 
     ^^^ (ptr=0)

END


# alloc_array16, get data, free array
spew("$test.in", <<END);
alloc_cell8(A)
alloc_cell8(B)
alloc_array16(ARR, 2)
alloc_cell8(IDX)
alloc_cell8(T)

set16(T, 12)  set8(IDX, 0) put_array8(ARR, IDX, T)
set16(T, 34)  set8(IDX, 1) put_array8(ARR, IDX, T)
set16(T, 255) set8(IDX, 2) put_array8(ARR, IDX, T) // no-op

set8(IDX, 0) get_array8(ARR, IDX, A)
set8(IDX, 1) get_array8(ARR, IDX, B)
set8(IDX, 2) get_array8(ARR, IDX, T) // no-op

free_array16(ARR)
END
capture_ok("bfpp $test.in", <<END);
[ Generated by bfpp, see https://github.com/pauloscustodio/bf
  5662 instructions, 16 tape cells
]
[-]>[-]>>>>>[-]>[-]++++++++++++>[-]<<[-]>>[-]>[-]>[-]<<[-]<<[->>+>>+<<<<]>>>>[-<
<<<+>>>>][-]>[-]<[-]<[->+>+<<]>>[-<<+>>][-]<[-<<->>][-]>[-]<[-]<<[->>+<<]+>>>+<[
->[-<<<->>>]<][-]>[-]<[-]>[-]>[-]<[-]<<<[->>>+>+<<<<]>>>>[-<<<<+>>>>][-]>[-]<[-]
<[->+<]+>>+<[->[-<<->>]<][-]>[-]<[-]<<[-]>[-<+>>+<]>[-<+>][-]>[-]<[-]<<[->>+<<]+
>>>+<[->[-<<<->>>]<][-]>[-]<<<[>>[-]<<<<<<<<<<[-]>>>>>[-<<<<<+>>>>>>>>>>+<<<<<]>
>>>>[-<<<<<+>>>>>][-]<<-]>[<<[-]+>>>[-]<<<<[-]<<[->>+>>>>+<<<<<<]>>>>>>[-<<<<<<+
>>>>>>][-]>[-]<[-]<<<[->>>+>+<<<<]>>>>[-<<<<+>>>>][-]<[-<<<<->>>>][-]>[-]<[-]<<<
<[->>>>+<<<<]+>>>>>+<[->[-<<<<<->>>>>]<][-]>[-]<[-]>[-]>[-]<[-]<<<<<[->>>>>+>+<<
<<<<]>>>>>>[-<<<<<<+>>>>>>][-]>[-]<[-]<[->+<]+>>+<[->[-<<->>]<][-]>[-]<[-]<<[-]>
[-<+>>+<]>[-<+>][-]>[-]<[-]<<[->>+<<]+>>>+<[->[-<<<->>>]<][-]>[-]<<<[>>[-]<<<<<<
<<<<[-]>>>[-<<<+>>>>>>>>>>+<<<<<<<]>>>>>>>[-<<<<<<<+>>>>>>>][-]<<-]>[-]<[-]>[-]<
<-]<[-]>[-]<<<[-]>[-]<<[-]++++++++++++++++++++++++++++++++++>[-]<<[-]+>>[-]>[-]>
[-]<<[-]<<[->>+>>+<<<<]>>>>[-<<<<+>>>>][-]>[-]<[-]<[->+>+<<]>>[-<<+>>][-]<[-<<->
>][-]>[-]<[-]<<[->>+<<]+>>>+<[->[-<<<->>>]<][-]>[-]<[-]>[-]>[-]<[-]<<<[->>>+>+<<
<<]>>>>[-<<<<+>>>>][-]>[-]<[-]<[->+<]+>>+<[->[-<<->>]<][-]>[-]<[-]<<[-]>[-<+>>+<
]>[-<+>][-]>[-]<[-]<<[->>+<<]+>>>+<[->[-<<<->>>]<][-]>[-]<<<[>>[-]<<<<<<<<<<[-]>
>>>>[-<<<<<+>>>>>>>>>>+<<<<<]>>>>>[-<<<<<+>>>>>][-]<<-]>[<<[-]+>>>[-]<<<<[-]<<[-
>>+>>>>+<<<<<<]>>>>>>[-<<<<<<+>>>>>>][-]>[-]<[-]<<<[->>>+>+<<<<]>>>>[-<<<<+>>>>]
[-]<[-<<<<->>>>][-]>[-]<[-]<<<<[->>>>+<<<<]+>>>>>+<[->[-<<<<<->>>>>]<][-]>[-]<[-
]>[-]>[-]<[-]<<<<<[->>>>>+>+<<<<<<]>>>>>>[-<<<<<<+>>>>>>][-]>[-]<[-]<[->+<]+>>+<
[->[-<<->>]<][-]>[-]<[-]<<[-]>[-<+>>+<]>[-<+>][-]>[-]<[-]<<[->>+<<]+>>>+<[->[-<<
<->>>]<][-]>[-]<<<[>>[-]<<<<<<<<<<[-]>>>[-<<<+>>>>>>>>>>+<<<<<<<]>>>>>>>[-<<<<<<
<+>>>>>>>][-]<<-]>[-]<[-]>[-]<<-]<[-]>[-]<<<[-]>[-]<<[-]++++++++++++++++++++++++
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++>[-]<<[-]
++>>[-]>[-]>[-]<<[-]<<[->>+>>+<<<<]>>>>[-<<<<+>>>>][-]>[-]<[-]<[->+>+<<]>>[-<<+>
>][-]<[-<<->>][-]>[-]<[-]<<[->>+<<]+>>>+<[->[-<<<->>>]<][-]>[-]<[-]>[-]>[-]<[-]<
<<[->>>+>+<<<<]>>>>[-<<<<+>>>>][-]>[-]<[-]<[->+<]+>>+<[->[-<<->>]<][-]>[-]<[-]<<
[-]>[-<+>>+<]>[-<+>][-]>[-]<[-]<<[->>+<<]+>>>+<[->[-<<<->>>]<][-]>[-]<<<[>>[-]<<
<<<<<<<<[-]>>>>>[-<<<<<+>>>>>>>>>>+<<<<<]>>>>>[-<<<<<+>>>>>][-]<<-]>[<<[-]+>>>[-
]<<<<[-]<<[->>+>>>>+<<<<<<]>>>>>>[-<<<<<<+>>>>>>][-]>[-]<[-]<<<[->>>+>+<<<<]>>>>
[-<<<<+>>>>][-]<[-<<<<->>>>][-]>[-]<[-]<<<<[->>>>+<<<<]+>>>>>+<[->[-<<<<<->>>>>]
<][-]>[-]<[-]>[-]>[-]<[-]<<<<<[->>>>>+>+<<<<<<]>>>>>>[-<<<<<<+>>>>>>][-]>[-]<[-]
<[->+<]+>>+<[->[-<<->>]<][-]>[-]<[-]<<[-]>[-<+>>+<]>[-<+>][-]>[-]<[-]<<[->>+<<]+
>>>+<[->[-<<<->>>]<][-]>[-]<<<[>>[-]<<<<<<<<<<[-]>>>[-<<<+>>>>>>>>>>+<<<<<<<]>>>
>>>>[-<<<<<<<+>>>>>>>][-]<<-]>[-]<[-]>[-]<<-]<[-]>[-]<<<[-]>[-]<<<[-]>>[-]>[-]>[
-]<<[-]<<[->>+>>+<<<<]>>>>[-<<<<+>>>>][-]>[-]<[-]<[->+>+<<]>>[-<<+>>][-]<[-<<->>
][-]>[-]<[-]<<[->>+<<]+>>>+<[->[-<<<->>>]<][-]>[-]<[-]>[-]>[-]<[-]<<<[->>>+>+<<<
<]>>>>[-<<<<+>>>>][-]>[-]<[-]<[->+<]+>>+<[->[-<<->>]<][-]>[-]<[-]<<[-]>[-<+>>+<]
>[-<+>][-]>[-]<[-]<<[->>+<<]+>>>+<[->[-<<<->>>]<][-]>[-]<<<[>>[-]<<<<<<<<<<<<[-]
>>[-<<+>>>>>>>>>>>>+<<<<<<<<<<]>>>>>>>>>>[-<<<<<<<<<<+>>>>>>>>>>][-]<<-]>[<<[-]+
>>>[-]<<<<[-]<<[->>+>>>>+<<<<<<]>>>>>>[-<<<<<<+>>>>>>][-]>[-]<[-]<<<[->>>+>+<<<<
]>>>>[-<<<<+>>>>][-]<[-<<<<->>>>][-]>[-]<[-]<<<<[->>>>+<<<<]+>>>>>+<[->[-<<<<<->
>>>>]<][-]>[-]<[-]>[-]>[-]<[-]<<<<<[->>>>>+>+<<<<<<]>>>>>>[-<<<<<<+>>>>>>][-]>[-
]<[-]<[->+<]+>>+<[->[-<<->>]<][-]>[-]<[-]<<[-]>[-<+>>+<]>[-<+>][-]>[-]<[-]<<[->>
+<<]+>>>+<[->[-<<<->>>]<][-]>[-]<<<[>>[-]<<<<<<<<<<<<<<[-]>>>>[-<<<<+>>>>>>>>>>>
>>>+<<<<<<<<<<]>>>>>>>>>>[-<<<<<<<<<<+>>>>>>>>>>][-]<<-]>[-]<[-]>[-]<<-]<[-]>[-]
<<<[-]>[-]<<<[-]+>>[-]>[-]>[-]<<[-]<<[->>+>>+<<<<]>>>>[-<<<<+>>>>][-]>[-]<[-]<[-
>+>+<<]>>[-<<+>>][-]<[-<<->>][-]>[-]<[-]<<[->>+<<]+>>>+<[->[-<<<->>>]<][-]>[-]<[
-]>[-]>[-]<[-]<<<[->>>+>+<<<<]>>>>[-<<<<+>>>>][-]>[-]<[-]<[->+<]+>>+<[->[-<<->>]
<][-]>[-]<[-]<<[-]>[-<+>>+<]>[-<+>][-]>[-]<[-]<<[->>+<<]+>>>+<[->[-<<<->>>]<][-]
>[-]<<<[>>[-]<<<<<<<<<<<[-]>[-<+>>>>>>>>>>>+<<<<<<<<<<]>>>>>>>>>>[-<<<<<<<<<<+>>
>>>>>>>>][-]<<-]>[<<[-]+>>>[-]<<<<[-]<<[->>+>>>>+<<<<<<]>>>>>>[-<<<<<<+>>>>>>][-
]>[-]<[-]<<<[->>>+>+<<<<]>>>>[-<<<<+>>>>][-]<[-<<<<->>>>][-]>[-]<[-]<<<<[->>>>+<
<<<]+>>>>>+<[->[-<<<<<->>>>>]<][-]>[-]<[-]>[-]>[-]<[-]<<<<<[->>>>>+>+<<<<<<]>>>>
>>[-<<<<<<+>>>>>>][-]>[-]<[-]<[->+<]+>>+<[->[-<<->>]<][-]>[-]<[-]<<[-]>[-<+>>+<]
>[-<+>][-]>[-]<[-]<<[->>+<<]+>>>+<[->[-<<<->>>]<][-]>[-]<<<[>>[-]<<<<<<<<<<<<<[-
]>>>[-<<<+>>>>>>>>>>>>>+<<<<<<<<<<]>>>>>>>>>>[-<<<<<<<<<<+>>>>>>>>>>][-]<<-]>[-]
<[-]>[-]<<-]<[-]>[-]<<<[-]>[-]<<<[-]++>>[-]>[-]>[-]<<[-]<<[->>+>>+<<<<]>>>>[-<<<
<+>>>>][-]>[-]<[-]<[->+>+<<]>>[-<<+>>][-]<[-<<->>][-]>[-]<[-]<<[->>+<<]+>>>+<[->
[-<<<->>>]<][-]>[-]<[-]>[-]>[-]<[-]<<<[->>>+>+<<<<]>>>>[-<<<<+>>>>][-]>[-]<[-]<[
->+<]+>>+<[->[-<<->>]<][-]>[-]<[-]<<[-]>[-<+>>+<]>[-<+>][-]>[-]<[-]<<[->>+<<]+>>
>+<[->[-<<<->>>]<][-]>[-]<<<[>>[-]<<<<<[-]<<<<<[->>>>>+>>>>>+<<<<<<<<<<]>>>>>>>>
>>[-<<<<<<<<<<+>>>>>>>>>>][-]<<-]>[<<[-]+>>>[-]<<<<[-]<<[->>+>>>>+<<<<<<]>>>>>>[
-<<<<<<+>>>>>>][-]>[-]<[-]<<<[->>>+>+<<<<]>>>>[-<<<<+>>>>][-]<[-<<<<->>>>][-]>[-
]<[-]<<<<[->>>>+<<<<]+>>>>>+<[->[-<<<<<->>>>>]<][-]>[-]<[-]>[-]>[-]<[-]<<<<<[->>
>>>+>+<<<<<<]>>>>>>[-<<<<<<+>>>>>>][-]>[-]<[-]<[->+<]+>>+<[->[-<<->>]<][-]>[-]<[
-]<<[-]>[-<+>>+<]>[-<+>][-]>[-]<[-]<<[->>+<<]+>>>+<[->[-<<<->>>]<][-]>[-]<<<[>>[
-]<<<<<<<[-]<<<[->>>+>>>>>>>+<<<<<<<<<<]>>>>>>>>>>[-<<<<<<<<<<+>>>>>>>>>>][-]<<-
]>[-]<[-]>[-]<<-]<[-]>[-]<<<[-]>[-]<<<<<<<[-]>[-]>[-]>[-]<<<<<
END
capture_ok("bfpp $test.in | bf -D", <<END);
Tape: 12  34   0   0   0   0   2 255 
     ^^^ (ptr=0)

END

unlink_testfiles;
done_testing;

#!/usr/bin/env perl

BEGIN { use lib 't'; require 'testlib.pl'; }

use Modern::Perl;

# add16s - error no arguments
spew("$test.in", "add16s");
capture_nok("bfpp $test.in", <<END);
$test.in:1:7: error: expected '(' after macro name 'add16s'
END

# add16s - error empty arguments
spew("$test.in", "add16s()");
capture_nok("bfpp $test.in", <<END);
$test.in:1:9: error: macro 'add16s' expects 2 arguments
END

# add16s - error too many arguments
spew("$test.in", "add16s(A,B,C)");
capture_nok("bfpp $test.in", <<END);
$test.in:1:11: error: expected ')' at end of macro call, found ','
END

# add16s(a,b)
spew("$test.in", <<END);
alloc_cell16(A)
alloc_cell16(B)
add16s(A,B)
END
capture_ok("bfpp $test.in", <<END);
[ Generated by bfpp, see https://github.com/pauloscustodio/bf
  2137 instructions, 16 tape cells
]
[-]>[-]>[-]>[-]>[-]>[-]>[-]<<[-]<<<<[->>>>+>>+<<<<<<]>>>>>>[-<<<<<<+>>>>>>][-]>[
-]<[-]<<<<[->>>>+>+<<<<<]>>>>>[-<<<<<+>>>>>][-]<[-<<<<<<+>>>>>>][-]<[-]<<<<<[->>
>>>+>+<<<<<<]>>>>>>[-<<<<<<+>>>>>>][-]>[-]>[-]>[-]>[-]<<<<[-]<[->+>>>>+<<<<<]>>>
>>[-<<<<<+>>>>>][-]<<<[-]<<<[->>>+>>>+<<<<<<]>>>>>>[-<<<<<<+>>>>>>][-]<<[-]<<[->
>+>>+<<<<]>>>>[-<<<<+>>>>][-]>[-]>[-]<<[-]<<[->>+<<]>>>>>[-]>[-]<[-]<<<[->>>+<<<
]+>>>>+<[->[-<<<<->>>>]<][-]>[-]<[-]>[-]<[-]<<<[->>>+<<<]+>>>>+<[->[-<<<<->>>>]<
][-]>[-]<[-]<<[-]<<<<[->>>>+>>+<<<<<<]>>>>>>[-<<<<<<+>>>>>>][-]>[-]<[-]<<[->>+<<
]+>>>+<[->[-<<<->>>]<][-]>[-]<[-]>[-]<[-]<<[->>+<<]+>>>+<[->[-<<<->>>]<][-]>[-]<
<<<[->>[-]<[->+<]<]<<[-]>>>>[-<<<<+>>>>]<<[-]>[-]>[-]<<[-]>[-]<[-]<<[->>+>+<<<]>
>>[-<<<+>>>][-]>[-]<[-]<[->+<]+>>+<[->[-<<->>]<][-]>[-]<[-]>[-]<[-]<[->+<]+>>+<[
->[-<<->>]<][-]>[-]<<[<<<<->->>>>[-]<<<[-]<<[->>+>>>+<<<<<]>>>>>[-<<<<<+>>>>>][-
]>[-]>[-]<<[-]<<<[->>>+<<<]>>>>>>[-]>[-]<[-]<<<[->>>+<<<]+>>>>+<[->[-<<<<->>>>]<
][-]>[-]<[-]>[-]<[-]<<<[->>>+<<<]+>>>>+<[->[-<<<<->>>>]<][-]>[-]<[-]<<[-]<<<<<[-
>>>>>+>>+<<<<<<<]>>>>>>>[-<<<<<<<+>>>>>>>][-]>[-]<[-]<<[->>+<<]+>>>+<[->[-<<<->>
>]<][-]>[-]<[-]>[-]<[-]<<[->>+<<]+>>>+<[->[-<<<->>>]<][-]>[-]<<<<[->>[-]<[->+<]<
]<<<[-]>>>>>[-<<<<<+>>>>>]<<[-]>[-]>[-]<<[-]<[-]<<[->>+>+<<<]>>>[-<<<+>>>][-]>[-
]<[-]<[->+<]+>>+<[->[-<<->>]<][-]>[-]<[-]>[-]<[-]<[->+<]+>>+<[->[-<<->>]<][-]>[-
]<<][-]<<<<<[-]>>>>>[-]<[-]<<<[->>>+>+<<<<]>>>>[-<<<<+>>>>][-]>[-]<[-]<[->+<]+>>
+<[->[-<<->>]<][-]>[-]<[-]>[-]>[-]<<[-]<[->+<]>>>>[-]>[-]<[-]<<<[->>>+<<<]+>>>>+
<[->[-<<<<->>>>]<][-]>[-]<[-]>[-]<[-]<<<[->>>+<<<]+>>>>+<[->[-<<<<->>>>]<][-]>[-
]<[-]<<[-]<<<<[->>>>+>>+<<<<<<]>>>>>>[-<<<<<<+>>>>>>][-]>[-]<[-]<<[->>+<<]+>>>+<
[->[-<<<->>>]<][-]>[-]<[-]>[-]<[-]<<[->>+<<]+>>>+<[->[-<<<->>>]<][-]>[-]<<<<[->>
[-]<[->+<]<]<[-]>>>[-<<<+>>>]<<[-]>[-]>[-]<<[-]>[-]>[-]<[-]<<[->>+>+<<<]>>>[-<<<
+>>>][-]>[-]<[-]<[->+<]+>>+<[->[-<<->>]<][-]>[-]<[-]<<[-]>[-<+>>+<]>[-<+>][-]>[-
]<[-]<<[->>+<<]+>>>+<[->[-<<<->>>]<][-]>[-]<<<[<<<<<+>>>>>-][-]>[-]<<<<<[-]>[-]>
[-]>[-]<<<[-]>[-]<[-]<<<[->>>+>+<<<<]>>>>[-<<<<+>>>>][-]<[-<<<<<+>>>>>][-]>[-]<[
-]<[->+>+<<]>>[-<<+>>][-]<[-<<<<<+>>>>>][-]<<[-]>[-]<<<<<
END

# run add16s(a,b)
for my $A (-32767, -2, -1, 0, 1, 2, 32767) {
	for my $B (-32767, -2, -1, 0, 1, 2, 32767) {
		my $A16bit = $A & 0xFFFF;
		my $B16bit = $B & 0xFFFF;
		spew("$test.in", <<END);
		alloc_cell16(A)
		alloc_cell16(B)
		set16(A, $A16bit)
		set16(B, $B16bit)
		add16s(A, B)
		>(B+1)
END
		my $R = ($A + $B) & 0xFFFF;
		my $Rlo = sprintf("%3d", $R & 0xFF);
		my $Rhi = sprintf("%3d", ($R >> 8) & 0xFF);
		my $Blo = sprintf("%3d", $B & 0xFF);
		my $Bhi = sprintf("%3d", ($B >> 8) & 0xFF);
		capture_ok("bfpp $test.in | bf -D", <<END);
Tape:$Rlo $Rhi $Blo $Bhi 
                 ^^^ (ptr=3)

END
	}
}

unlink_testfiles;
done_testing;

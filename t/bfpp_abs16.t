#!/usr/bin/env perl

BEGIN { use lib 't'; require 'testlib.pl'; }

use Modern::Perl;

# abs16 - error no arguments
spew("$test.in", "abs16");
capture_nok("bfpp $test.in", <<END);
$test.in:1:6: error: expected '(' after macro name 'abs16'
END

# abs16 - error empty arguments
spew("$test.in", "abs16()");
capture_nok("bfpp $test.in", <<END);
$test.in:1:8: error: macro 'abs16' expects 1 argument
END

# abs16 - error too many arguments
spew("$test.in", "abs16(A,B");
capture_nok("bfpp $test.in", <<END);
$test.in:1:8: error: expected ')' at end of macro call, found ','
END

# abs16 - negate the cell value
spew("$test.in", "alloc_cell16(X) abs16(X)");
capture_ok("bfpp $test.in", <<END);
[-]>[-]>[-]>[-]>[-]<<[-]<<[->>+>>+<<<<]>>>>[-<<<<+>>>>][-]<[-]<<[->>+>+<<<]>>>[-
<<<+>>>][-]>[-]>[-]<[-]>[-]+++++++++++++++++++++++++++++++++++++++++++++++++++++
+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++<<[-]
>>>[-]>[-]<<<<[-]<[->+>>>>+<<<<<]>>>>>[-<<<<<+>>>>>][-]>[-]>[-]>[-]>[-]<<<<[-]<<
<<[->>>>+>>>>+<<<<<<<<]>>>>>>>>[-<<<<<<<<+>>>>>>>>][-]<<<[-]<<<[->>>+>>>+<<<<<<]
>>>>>>[-<<<<<<+>>>>>>][-]<<[-]<<[->>+>>+<<<<]>>>>[-<<<<+>>>>][-]>[-]>[-]<<[-]<<[
->>+<<]>>>>>[-]>[-]<[-]<<<[->>>+<<<]+>>>>+<[->[-<<<<->>>>]<][-]>[-]<[-]>[-]<[-]<
<<[->>>+<<<]+>>>>+<[->[-<<<<->>>>]<][-]>[-]<[-]<<[-]<<<<[->>>>+>>+<<<<<<]>>>>>>[
-<<<<<<+>>>>>>][-]>[-]<[-]<<[->>+<<]+>>>+<[->[-<<<->>>]<][-]>[-]<[-]>[-]<[-]<<[-
>>+<<]+>>>+<[->[-<<<->>>]<][-]>[-]<<<<[->>[-]<[->+<]<]<<[-]>>>>[-<<<<+>>>>]<<[-]
>[-]>[-]<<[-]>[-]<[-]<<[->>+>+<<<]>>>[-<<<+>>>][-]>[-]<[-]<[->+<]+>>+<[->[-<<->>
]<][-]>[-]<[-]>[-]<[-]<[->+<]+>>+<[->[-<<->>]<][-]>[-]<<[<<<<->->>>>[-]<<<[-]<<[
->>+>>>+<<<<<]>>>>>[-<<<<<+>>>>>][-]>[-]>[-]<<[-]<<<[->>>+<<<]>>>>>>[-]>[-]<[-]<
<<[->>>+<<<]+>>>>+<[->[-<<<<->>>>]<][-]>[-]<[-]>[-]<[-]<<<[->>>+<<<]+>>>>+<[->[-
<<<<->>>>]<][-]>[-]<[-]<<[-]<<<<<[->>>>>+>>+<<<<<<<]>>>>>>>[-<<<<<<<+>>>>>>>][-]
>[-]<[-]<<[->>+<<]+>>>+<[->[-<<<->>>]<][-]>[-]<[-]>[-]<[-]<<[->>+<<]+>>>+<[->[-<
<<->>>]<][-]>[-]<<<<[->>[-]<[->+<]<]<<<[-]>>>>>[-<<<<<+>>>>>]<<[-]>[-]>[-]<<[-]<
[-]<<[->>+>+<<<]>>>[-<<<+>>>][-]>[-]<[-]<[->+<]+>>+<[->[-<<->>]<][-]>[-]<[-]>[-]
<[-]<[->+<]+>>+<[->[-<<->>]<][-]>[-]<<][-]<<<<<<<<[-]>>>>>>>>[-]<[-]<<<[->>>+>+<
<<<]>>>>[-<<<<+>>>>][-]>[-]<[-]<[->+<]+>>+<[->[-<<->>]<][-]>[-]<[-]>[-]>[-]<<[-]
<[->+<]>>>>[-]>[-]<[-]<<<[->>>+<<<]+>>>>+<[->[-<<<<->>>>]<][-]>[-]<[-]>[-]<[-]<<
<[->>>+<<<]+>>>>+<[->[-<<<<->>>>]<][-]>[-]<[-]<<[-]<<<<[->>>>+>>+<<<<<<]>>>>>>[-
<<<<<<+>>>>>>][-]>[-]<[-]<<[->>+<<]+>>>+<[->[-<<<->>>]<][-]>[-]<[-]>[-]<[-]<<[->
>+<<]+>>>+<[->[-<<<->>>]<][-]>[-]<<<<[->>[-]<[->+<]<]<[-]>>>[-<<<+>>>]<<[-]>[-]>
[-]<<[-]>[-]>[-]<[-]<<[->>+>+<<<]>>>[-<<<+>>>][-]>[-]<[-]<[->+<]+>>+<[->[-<<->>]
<][-]>[-]<[-]<<[-]>[-<+>>+<]>[-<+>][-]>[-]<[-]<<[->>+<<]+>>>+<[->[-<<<->>>]<][-]
>[-]<<<[<<<<<<<<+>>>>>>>>-][-]>[-]<<<<<[-]>[-]>[-]>[-]<<<[-]<[-]<<<<[->>>>+>+<<<
<<]>>>>>[-<<<<<+>>>>>][-]>[-]<[-]<<[->>+>+<<<]>>>[-<<<+>>>][-]<[-<->][-]>[-]<[-]
<[->+<]+>>+<[->[-<<->>]<][-]>[-]<[-]>[-]>[-]<[-]<<[->>+>+<<<]>>>[-<<<+>>>][-]>[-
]<[-]<[->+<]+>>+<[->[-<<->>]<][-]>[-]<[-]<<[-]>[-<+>>+<]>[-<+>][-]>[-]<[-]<<[->>
+<<]+>>>+<[->[-<<<->>>]<][-]>[-]<<<[>>[-]<<<<<<[-]<<[->>+>>>>>>+<<<<<<<<]>>>>>>>
>[-<<<<<<<<+>>>>>>>>][-]>[-]>[-]>[-]>[-]<<<<[-]<<<<<<[->>>>>>+>>>>+<<<<<<<<<<]>>
>>>>>>>>[-<<<<<<<<<<+>>>>>>>>>>][-]<<<[-]<<<<<<[->>>>>>+>>>+<<<<<<<<<]>>>>>>>>>[
-<<<<<<<<<+>>>>>>>>>][-]<<[-]<<[->>+>>+<<<<]>>>>[-<<<<+>>>>][-]>[-]>[-]<<[-]<<[-
>>+<<]>>>>>[-]>[-]<[-]<<<[->>>+<<<]+>>>>+<[->[-<<<<->>>>]<][-]>[-]<[-]>[-]<[-]<<
<[->>>+<<<]+>>>>+<[->[-<<<<->>>>]<][-]>[-]<[-]<<[-]<<<<[->>>>+>>+<<<<<<]>>>>>>[-
<<<<<<+>>>>>>][-]>[-]<[-]<<[->>+<<]+>>>+<[->[-<<<->>>]<][-]>[-]<[-]>[-]<[-]<<[->
>+<<]+>>>+<[->[-<<<->>>]<][-]>[-]<<<<[->>[-]<[->+<]<]<<[-]>>>>[-<<<<+>>>>]<<[-]>
[-]>[-]<<[-]>[-]<[-]<<[->>+>+<<<]>>>[-<<<+>>>][-]>[-]<[-]<[->+<]+>>+<[->[-<<->>]
<][-]>[-]<[-]>[-]<[-]<[->+<]+>>+<[->[-<<->>]<][-]>[-]<<[<<<<->->>>>[-]<<<[-]<<[-
>>+>>>+<<<<<]>>>>>[-<<<<<+>>>>>][-]>[-]>[-]<<[-]<<<[->>>+<<<]>>>>>>[-]>[-]<[-]<<
<[->>>+<<<]+>>>>+<[->[-<<<<->>>>]<][-]>[-]<[-]>[-]<[-]<<<[->>>+<<<]+>>>>+<[->[-<
<<<->>>>]<][-]>[-]<[-]<<[-]<<<<<[->>>>>+>>+<<<<<<<]>>>>>>>[-<<<<<<<+>>>>>>>][-]>
[-]<[-]<<[->>+<<]+>>>+<[->[-<<<->>>]<][-]>[-]<[-]>[-]<[-]<<[->>+<<]+>>>+<[->[-<<
<->>>]<][-]>[-]<<<<[->>[-]<[->+<]<]<<<[-]>>>>>[-<<<<<+>>>>>]<<[-]>[-]>[-]<<[-]<[
-]<<[->>+>+<<<]>>>[-<<<+>>>][-]>[-]<[-]<[->+<]+>>+<[->[-<<->>]<][-]>[-]<[-]>[-]<
[-]<[->+<]+>>+<[->[-<<->>]<][-]>[-]<<][-]<<<<<<<<<<[-]>>>>>>>>>>[-]<[-]<<<[->>>+
>+<<<<]>>>>[-<<<<+>>>>][-]>[-]<[-]<[->+<]+>>+<[->[-<<->>]<][-]>[-]<[-]>[-]>[-]<<
[-]<[->+<]>>>>[-]>[-]<[-]<<<[->>>+<<<]+>>>>+<[->[-<<<<->>>>]<][-]>[-]<[-]>[-]<[-
]<<<[->>>+<<<]+>>>>+<[->[-<<<<->>>>]<][-]>[-]<[-]<<[-]<<<<[->>>>+>>+<<<<<<]>>>>>
>[-<<<<<<+>>>>>>][-]>[-]<[-]<<[->>+<<]+>>>+<[->[-<<<->>>]<][-]>[-]<[-]>[-]<[-]<<
[->>+<<]+>>>+<[->[-<<<->>>]<][-]>[-]<<<<[->>[-]<[->+<]<]<[-]>>>[-<<<+>>>]<<[-]>[
-]>[-]<<[-]>[-]>[-]<[-]<<[->>+>+<<<]>>>[-<<<+>>>][-]>[-]<[-]<[->+<]+>>+<[->[-<<-
>>]<][-]>[-]<[-]<<[-]>[-<+>>+<]>[-<+>][-]>[-]<[-]<<[->>+<<]+>>>+<[->[-<<<->>>]<]
[-]>[-]<<<[<<<<<<<<<<+>>>>>>>>>>-][-]>[-]<<<<<[-]>[-]>[-]>[-]<<<<<-][-]>[-]<[-]>
[-]>[-]<[-]<<<<<[->>>>>+>+<<<<<<]>>>>>>[-<<<<<<+>>>>>>][-]>[-]<[-]<[->+<]+>>+<[-
>[-<<->>]<][-]>[-]<[-]<<[-]>[-<+>>+<]>[-<+>][-]>[-]<[-]<<[->>+<<]+>>>+<[->[-<<<-
>>>]<][-]>[-]<<<[<<<<<<[-]+>[-]>>>>>-]>[<<<<<<<[-]>[-]>>>>>>-]<[-]>[-]<<<<<[-]>>
>[-]<<<[-]>>>[-]>[-]<<<<[-]<<[->>+>>>>+<<<<<<]>>>>>>[-<<<<<<+>>>>>>][-]>[-]<[-]<
<<<[->>>>+<<<<]+>>>>>+<[->[-<<<<<->>>>>]<][-]>[-]<[-]<[-]<<<<[->>>>+>+<<<<<]>>>>
>[-<<<<<+>>>>>][-]>[-]<[-]<[->+<]+>>+<[->[-<<->>]<][-]>[-]<[-]>[-]>[-]<<[-]<<<<[
->>>>+<<<<]>>>>>>>[-]>[-]<[-]<<<[->>>+<<<]+>>>>+<[->[-<<<<->>>>]<][-]>[-]<[-]>[-
]<[-]<<<[->>>+<<<]+>>>>+<[->[-<<<<->>>>]<][-]>[-]<[-]<<[-]<<[->>+>>+<<<<]>>>>[-<
<<<+>>>>][-]>[-]<[-]<<[->>+<<]+>>>+<[->[-<<<->>>]<][-]>[-]<[-]>[-]<[-]<<[->>+<<]
+>>>+<[->[-<<<->>>]<][-]>[-]<<<<[->>[-]<[->+<]<]<<<<[-]>>>>>>[-<<<<<<+>>>>>>]<<[
-]>[-]>[-]<<[-]>[-]>[-]<[-]<<<<<[->>>>>+>+<<<<<<]>>>>>>[-<<<<<<+>>>>>>][-]>[-]<[
-]<[->+<]+>>+<[->[-<<->>]<][-]>[-]<[-]<<[-]>[-<+>>+<]>[-<+>][-]>[-]<[-]<<[->>+<<
]+>>>+<[->[-<<<->>>]<][-]>[-]<<<[<<<<<<[-]+>[-]>>>>>-]>[<<<<<<<[-]>[-]>>>>>>-]<[
-]>[-]<<<<<[-]>>>[-]<<[-]>[-]<<[-]>[-]>[-]<[-]<<<[->>>+>+<<<<]>>>>[-<<<<+>>>>][-
]>[-]<[-]<[->+<]+>>+<[->[-<<->>]<][-]>[-]<[-]<<[-]>[-<+>>+<]>[-<+>][-]>[-]<[-]<<
[->>+<<]+>>>+<[->[-<<<->>>]<][-]>[-]<<<[>>[-]>[-]>[-]>[-]>[-]<<[-]<<[->>+>>+<<<<
]>>>>[-<<<<+>>>>][-]>[-]<[-]<<<<<<<<<<[->>>>>>>>>>+>+<<<<<<<<<<<]>>>>>>>>>>>[-<<
<<<<<<<<<+>>>>>>>>>>>][-]<[-<<<<->>>>][-]<[-]<<<[->>>+>+<<<<]>>>>[-<<<<+>>>>][-]
>[-]>[-]>[-]>[-]<<<<[-]<[->+>>>>+<<<<<]>>>>>[-<<<<<+>>>>>][-]<<<[-]<<<[->>>+>>>+
<<<<<<]>>>>>>[-<<<<<<+>>>>>>][-]<<[-]<<[->>+>>+<<<<]>>>>[-<<<<+>>>>][-]>[-]>[-]<
<[-]<<[->>+<<]>>>>>[-]>[-]<[-]<<<[->>>+<<<]+>>>>+<[->[-<<<<->>>>]<][-]>[-]<[-]>[
-]<[-]<<<[->>>+<<<]+>>>>+<[->[-<<<<->>>>]<][-]>[-]<[-]<<[-]<<<<[->>>>+>>+<<<<<<]
>>>>>>[-<<<<<<+>>>>>>][-]>[-]<[-]<<[->>+<<]+>>>+<[->[-<<<->>>]<][-]>[-]<[-]>[-]<
[-]<<[->>+<<]+>>>+<[->[-<<<->>>]<][-]>[-]<<<<[->>[-]<[->+<]<]<<[-]>>>>[-<<<<+>>>
>]<<[-]>[-]>[-]<<[-]>[-]<[-]<<[->>+>+<<<]>>>[-<<<+>>>][-]>[-]<[-]<[->+<]+>>+<[->
[-<<->>]<][-]>[-]<[-]>[-]<[-]<[->+<]+>>+<[->[-<<->>]<][-]>[-]<<[<<<<->->>>>[-]<<
<[-]<<[->>+>>>+<<<<<]>>>>>[-<<<<<+>>>>>][-]>[-]>[-]<<[-]<<<[->>>+<<<]>>>>>>[-]>[
-]<[-]<<<[->>>+<<<]+>>>>+<[->[-<<<<->>>>]<][-]>[-]<[-]>[-]<[-]<<<[->>>+<<<]+>>>>
+<[->[-<<<<->>>>]<][-]>[-]<[-]<<[-]<<<<<[->>>>>+>>+<<<<<<<]>>>>>>>[-<<<<<<<+>>>>
>>>][-]>[-]<[-]<<[->>+<<]+>>>+<[->[-<<<->>>]<][-]>[-]<[-]>[-]<[-]<<[->>+<<]+>>>+
<[->[-<<<->>>]<][-]>[-]<<<<[->>[-]<[->+<]<]<<<[-]>>>>>[-<<<<<+>>>>>]<<[-]>[-]>[-
]<<[-]<[-]<<[->>+>+<<<]>>>[-<<<+>>>][-]>[-]<[-]<[->+<]+>>+<[->[-<<->>]<][-]>[-]<
[-]>[-]<[-]<[->+<]+>>+<[->[-<<->>]<][-]>[-]<<][-]<<<<<[-]>>>>>[-]<[-]<<[->>+>+<<
<]>>>[-<<<+>>>][-]>[-]<[-]<[->+<]+>>+<[->[-<<->>]<][-]>[-]<[-]>[-]>[-]<<[-]<[->+
<]>>>>[-]>[-]<[-]<<<[->>>+<<<]+>>>>+<[->[-<<<<->>>>]<][-]>[-]<[-]>[-]<[-]<<<[->>
>+<<<]+>>>>+<[->[-<<<<->>>>]<][-]>[-]<[-]<<[-]<<<<<[->>>>>+>>+<<<<<<<]>>>>>>>[-<
<<<<<<+>>>>>>>][-]>[-]<[-]<<[->>+<<]+>>>+<[->[-<<<->>>]<][-]>[-]<[-]>[-]<[-]<<[-
>>+<<]+>>>+<[->[-<<<->>>]<][-]>[-]<<<<[->>[-]<[->+<]<]<[-]>>>[-<<<+>>>]<<[-]>[-]
>[-]<<[-]>[-]>[-]<[-]<<[->>+>+<<<]>>>[-<<<+>>>][-]>[-]<[-]<[->+<]+>>+<[->[-<<->>
]<][-]>[-]<[-]<<[-]>[-<+>>+<]>[-<+>][-]>[-]<[-]<<[->>+<<]+>>>+<[->[-<<<->>>]<][-
]>[-]<<<[<<<<<+>>>>>-][-]>[-]<<<<<[-]>[-]>[-]>[-]<<<[-]>[-]<[-]<<<<<<<<<[->>>>>>
>>>+>+<<<<<<<<<<]>>>>>>>>>>[-<<<<<<<<<<+>>>>>>>>>>][-]<[-<<<->>>][-]>[-]<[-]<[->
+>+<<]>>[-<<+>>][-]<[-<<<->>>][-]<<[-]>[-]<<<<<<<<<[-]>>>>>>[-<<<<<<+>>>>>>]<<<<
<[-]>>>>>>[-<<<<<<+>>>>>>]<[-]>[-]<<<-][-]>[-]<<<[-]>[-]<<<
END

# abs16 - execute a test program
for my $A (-32767, -32766, -1, 0, 1, 32766, 32767) {
	my $A16bit = $A & 0xFFFF;
	spew("$test.in", "alloc_cell16(X) set16(X, $A16bit) abs16(X) >(X+1)");
	my $R = abs($A) & 0xFFFF;
	my $Rlo = sprintf("%3d", $R & 0xFF);
	my $Rhi = sprintf("%3d", ($R >> 8) & 0xFF);
	capture_ok("bfpp $test.in | bf -D", <<END);
Tape:$Rlo $Rhi 
         ^^^ (ptr=1)

END
}

unlink_testfiles;
done_testing;
